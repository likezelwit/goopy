<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Goopy â€” Riwayat Transaksi</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif;}
body{background-color:#f0f4f8;color:#333;min-height:100vh;display:flex;flex-direction:column;}
.header{background:linear-gradient(135deg,#0083FF 0%,#00C2FF 100%);color:white;padding:20px;padding-top:40px;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
.header-top{display:flex;align-items:center;margin-bottom:20px;}
.back-btn{width:35px;height:35px;border-radius:50%;background-color:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:1.2rem;cursor:pointer;margin-right:15px;}
.header h1{font-size:1.2rem;font-weight:600;}
.filter-tabs{display:flex;background:rgba(255,255,255,0.2);border-radius:10px;padding:5px;margin-bottom:20px;}
.filter-tab{flex:1;padding:10px;text-align:center;border-radius:8px;cursor:pointer;transition:all 0.2s;}
.filter-tab.active{background:rgba(255,255,255,0.3);font-weight:600;}
.main-content{flex-grow:1;padding:20px;display:flex;flex-direction:column;}
.transaction-history{background:white;border-radius:15px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);flex-grow:1;display:flex;flex-direction:column;}
.history-list{flex-grow:1;overflow-y:auto;}
.history-item{display:flex;justify-content:space-between;align-items:center;padding:15px 0;border-bottom:1px solid #f0f0f0;}
.history-item:last-child{border-bottom:none;}
.history-details{display:flex;align-items:center;}
.history-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;margin-right:15px;}
.history-icon.in{background-color:#e8f5e9;color:#4caf50;}
.history-icon.out{background-color:#ffebee;color:#f44336;}
.history-icon.info{background-color:#e3f2fd;color:#2196f3;}
.history-info p{font-weight:500;color:#333;}
.history-info span{font-size:0.8rem;color:#999;}
.history-date{font-size:0.75rem;color:#999;}
.history-amount{font-weight:600;text-align:right;}
.history-amount.in{color:#4caf50;}
.history-amount.out{color:#f44336;}
.empty-state,.loading-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;}
.empty-state .icon{width:60px;height:60px;background-color:#f0f4f8;color:#999;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8rem;margin-bottom:15px;}
.empty-state h3{margin-bottom:10px;color:#555;}
.empty-state p{color:#999;margin-bottom:20px;}
.loading-spinner{width:40px;height:40px;border:4px solid #f0f4f8;border-top:4px solid #0083FF;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:15px;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.loading-state p{color:#999;}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-top">
    <div class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </div>
    <h1>Riwayat Transaksi</h1>
  </div>
  <div class="filter-tabs">
    <div class="filter-tab active" data-filter="all">Semua</div>
    <div class="filter-tab" data-filter="in">Masuk</div>
    <div class="filter-tab" data-filter="out">Keluar</div>
  </div>
</div>

<!-- MAIN -->
<div class="main-content">
  <div class="transaction-history">
    <div class="history-list" id="historyList">
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Memuat riwayat transaksi...</p>
      </div>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAgx2eZh68OK9RKi5ilKkN7FCYPAC4fqEA",
  authDomain: "goopy-1a485.firebaseapp.com",
  projectId: "goopy-1a485",
  storageBucket: "goopy-1a485.firebasestorage.app",
  messagingSenderId: "478710064427",
  appId: "1:478710064427:web:a3b0c455c91f2c12db916e"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
</script>

<script>
const historyListEl = document.getElementById("historyList");
const filterTabs = document.querySelectorAll(".filter-tab");
let currentUser = null;
let transactions = [];
let currentFilter = "all";

// ðŸ”™ Kembali
function goBack(){ window.location.href = "home.html"; }

// ðŸ”„ Render Transaksi
function renderTransactions(){
  let filtered = transactions;
  if(currentFilter === "in") filtered = transactions.filter(t => t.recipientId === currentUser.uid);
  if(currentFilter === "out") filtered = transactions.filter(t => t.senderId === currentUser.uid);

  if(filtered.length === 0){
    historyListEl.innerHTML = `
      <div class="empty-state">
        <div class="icon"><i class="fa-solid fa-clock-rotate-left"></i></div>
        <h3>Belum ada transaksi</h3>
        <p>Mulai kirim atau terima saldo untuk melihat riwayat di sini.</p>
      </div>`;
    return;
  }

  historyListEl.innerHTML = filtered.sort((a,b)=>b.timestamp - a.timestamp).map(tx=>{
    const isOut = tx.senderId === currentUser.uid;
    const iconType = isOut ? "out" : "in";
    const iconClass = isOut ? "fa-arrow-up" : "fa-arrow-down";
    const title = isOut ? `Kirim ke ${tx.recipientName || 'Pengguna Lain'}` :
                          `Terima dari ${tx.senderName || 'Pengguna Lain'}`;
    const amount = (tx.amount || 0).toLocaleString("id-ID");
    const amountTxt = (isOut ? "-" : "+") + " Rp" + amount;
    const amountClass = isOut ? "out" : "in";
    const dateStr = new Date(tx.timestamp.seconds*1000 || Date.now()).toLocaleString("id-ID", {
      year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'
    });
    const subtitle = tx.note || (isOut ? "Transaksi Keluar" : "Transaksi Masuk");

    return `
    <div class="history-item">
      <div class="history-details">
        <div class="history-icon ${iconType}"><i class="fa-solid ${iconClass}"></i></div>
        <div class="history-info">
          <p>${title}</p>
          <span>${subtitle}</span>
          <div class="history-date">${dateStr}</div>
        </div>
      </div>
      <div class="history-amount ${amountClass}">${amountTxt}</div>
    </div>`;
  }).join("");
}

// ðŸ” Cek login dan ambil transaksi realtime
auth.onAuthStateChanged(user=>{
  if(!user) return window.location.href = "index.html";
  currentUser = user;

  // Listen transaksi realtime (masuk & keluar)
  db.collection("transactions")
    .where("senderId","==",currentUser.uid)
    .onSnapshot(sentSnap=>{
      const sent = sentSnap.docs.map(d=>({...d.data(), id:d.id}));
      db.collection("transactions")
        .where("recipientId","==",currentUser.uid)
        .onSnapshot(recvSnap=>{
          const recv = recvSnap.docs.map(d=>({...d.data(), id:d.id}));
          transactions = [...sent, ...recv];
          renderTransactions();
        });
    });
});

// ðŸ”˜ Filter Tabs
filterTabs.forEach(tab=>{
  tab.addEventListener("click",()=>{
    filterTabs.forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    currentFilter = tab.dataset.filter;
    renderTransactions();
  });
});
</script>

</body>
</html>

<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Goopy — Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif;}
body{background-color:#f0f4f8;color:#333;min-height:100vh;display:flex;flex-direction:column;overflow:hidden;}
.header{background:linear-gradient(135deg,#0083FF 0%,#00C2FF 100%);color:white;padding:20px;padding-top:40px;border-radius:0 0 25px 25px;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
.header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.header h1{font-size:1.2rem;font-weight:600;}
.profile-icon{width:35px;height:35px;border-radius:50%;background-color:rgba(255,255,255,0.3);display:flex;align-items:center;justify-content:center;font-size:1.2rem;cursor:pointer;}
.balance-card{background:rgba(255,255,255,0.2);backdrop-filter:blur(10px);border-radius:15px;padding:20px;text-align:center;}
.balance-label{font-size:0.9rem;opacity:0.9;}
.balance-amount{font-size:2.5rem;font-weight:700;margin:10px 0;}
.balance-amount span{font-size:1.5rem;font-weight:400;}
.user-info{font-size:0.9rem;opacity:0.9;}
.main-content{flex-grow:1;padding:20px;display:flex;flex-direction:column;gap:20px;}
.quick-actions{background:white;border-radius:15px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.quick-actions h2{font-size:1.1rem;color:#555;margin-bottom:15px;font-weight:600;}
.action-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;}
.action-item{display:flex;flex-direction:column;align-items:center;text-align:center;cursor:pointer;transition:transform 0.2s;}
.action-item:hover{transform:translateY(-3px);}
.action-item .icon{width:50px;height:50px;background-color:#e6f0ff;color:#0083FF;border-radius:15px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;margin-bottom:8px;}
.action-item .label{font-size:0.8rem;color:#666;}
.other-features{background:white;border-radius:15px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.other-features h2{font-size:1.1rem;color:#555;margin-bottom:15px;font-weight:600;}
.feature-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;}
.feature-item{display:flex;align-items:center;padding:12px;border-radius:10px;background-color:#f9f9f9;cursor:pointer;transition:all 0.2s;}
.feature-item:hover{background-color:#e6f0ff;}
.feature-item .icon{width:40px;height:40px;background-color:#e6f0ff;color:#0083FF;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;margin-right:12px;}
.feature-item .text h3{font-size:0.9rem;font-weight:600;color:#333;margin-bottom:3px;}
.feature-item .text p{font-size:0.75rem;color:#666;}
.transaction-history{background:white;border-radius:15px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.transaction-history h2{font-size:1.1rem;color:#555;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;}
.view-all{font-size:0.8rem;color:#0083FF;cursor:pointer;}
.history-list{max-height:250px;overflow-y:auto;}
.history-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f0f0f0;}
.history-item:last-child{border-bottom:none;}
.history-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:15px;font-size:1.2rem;}
.history-icon.in{background-color:#e8f5e9;color:#4caf50;}
.history-icon.out{background-color:#ffebee;color:#f44336;}
.history-info p{font-weight:500;}
.history-info span{font-size:0.8rem;color:#999;}
.history-amount{font-weight:600;}
.history-amount.in{color:#4caf50;}
.history-amount.out{color:#f44336;}
.bottom-nav{background:white;display:flex;justify-content:space-around;padding:10px 0;box-shadow:0 -2px 10px rgba(0,0,0,0.05);}
.nav-item{display:flex;flex-direction:column;align-items:center;color:#999;cursor:pointer;transition:color 0.2s;}
.nav-item.active{color:#0083FF;}
.nav-item .icon{font-size:1.5rem;}
.nav-item .label{font-size:0.75rem;margin-top:4px;}

/* popup & loading */
.popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000;}
.popup-content{background:white;border-radius:15px;padding:25px;width:90%;max-width:350px;text-align:center;animation:popIn 0.3s ease;}
@keyframes popIn{from{transform:scale(0.9);opacity:0;}to{transform:scale(1);opacity:1;}}
.popup-content h3{margin-bottom:15px;}
.popup-content p{margin-bottom:20px;}
.popup-content button{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:500;}
.btn-cancel{background:#f0f0f0;color:#333;margin-right:10px;}
.btn-primary{background:#0083FF;color:white;}
.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);backdrop-filter:blur(5px);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:999;}
.loading-bar{width:80%;max-width:300px;background:#e5e7eb;border-radius:10px;overflow:hidden;margin-top:15px;}
.loading-bar-inner{width:0%;height:10px;background:#0083FF;border-radius:10px;}
.loading-text{margin-top:10px;font-size:0.9rem;color:#333;}
.loading-done{font-size:2rem;color:#4caf50;margin-top:10px;display:none;}
</style>
</head>
<body>

<!-- Header & Main Dashboard -->
<div class="header">
  <div class="header-top">
    <h1>Goopy</h1>
    <div class="profile-icon"><i class="fas fa-user"></i></div>
  </div>
  <div class="balance-card">
    <p class="balance-label">Saldo Anda</p>
    <p class="balance-amount">Rp <span id="balanceAmount">0</span></p>
    <p class="user-info" id="userInfo">Halo, Pengguna</p>
  </div>
</div>
<div class="main-content">
  <!-- ... isi dashboard seperti action, fitur, riwayat ... -->
</div>

<!-- Popup untuk akun tidak ada -->
<div class="popup-overlay" id="missingUserPopup">
  <div class="popup-content">
    <h3>Akun Anda Tidak Terdaftar</h3>
    <p>Klik tombol di bawah untuk memulihkan/membuat akun Anda di database.</p>
    <button class="btn-primary" id="recoverUserBtn">Pulihkan Akun</button>
  </div>
</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display:none;">
  <p class="loading-text" id="loadingPercent">0%</p>
  <div class="loading-bar"><div class="loading-bar-inner" id="loadingBar"></div></div>
  <p class="loading-text" id="loadingStep">Memeriksa database...</p>
  <div class="loading-done" id="loadingDone">✔</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAgx2eZh68OK9RKi5ilKkN7FCYPAC4fqEA",
  authDomain: "goopy-1a485.firebaseapp.com",
  projectId: "goopy-1a485",
  storageBucket: "goopy-1a485.firebasestorage.app",
  messagingSenderId: "478710064427",
  appId: "1:478710064427:web:a3b0c455c91f2c12db916e"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* UI elements */
const missingUserPopup = document.getElementById('missingUserPopup');
const recoverUserBtn = document.getElementById('recoverUserBtn');
const loadingOverlay = document.getElementById('loadingOverlay');
const loadingPercent = document.getElementById('loadingPercent');
const loadingBar = document.getElementById('loadingBar');
const loadingStep = document.getElementById('loadingStep');
const loadingDone = document.getElementById('loadingDone');
const balanceEl = document.getElementById('balanceAmount');
const userInfo = document.getElementById('userInfo');

/* utility untuk update progress */
function setLoading(percent, step){
  loadingPercent.textContent = percent + '%';
  loadingBar.style.width = percent + '%';
  loadingStep.textContent = step;
}

/* cek auth & Firestore */
auth.onAuthStateChanged(async user=>{
  if(!user){ location.href='./login.html'; return; }

  try{
    const ref = db.collection('users').doc(user.uid);
    const docSnap = await ref.get();
    if(docSnap.exists){
      // data ada
      const data = docSnap.data();
      balanceEl.textContent = (data.balance||0).toLocaleString('id-ID');
      userInfo.textContent = `Halo, ${data.name||'Pengguna'}`;
      return; // dashboard siap ditampilkan
    }

    // data tidak ada → tampilkan popup
    missingUserPopup.style.display = 'flex';

  }catch(e){
    console.error(e);
    alert('Gagal memuat data. Silakan coba lagi.');
  }
});

/* tombol pulihkan akun */
recoverUserBtn.onclick = async ()=>{
  missingUserPopup.style.display='none';
  loadingOverlay.style.display='flex';
  setLoading(0,'Membuat akun...');

  const user = auth.currentUser;
  if(!user) return;

  const ref = db.collection('users').doc(user.uid);

  const steps = [
    {label:'Membuat auth account...', percent:20, fn:()=>Promise.resolve()},
    {label:'Menambahkan field pin...', percent:40, fn:()=>ref.set({pin:'', balance:0},{merge:true})},
    {label:'Menambahkan field settings...', percent:60, fn:()=>ref.set({settings:{theme:'light',language:'id',notifications:true}},{merge:true})},
    {label:'Memeriksa data Firestore...', percent:80, fn:()=>ref.get()},
    {label:'Selesai', percent:100, fn:()=>Promise.resolve()}
  ];

  for(const s of steps){
    loadingStep.textContent = s.label;
    await s.fn();
    setLoading(s.percent,s.label);
    await new Promise(r=>setTimeout(r,400)); // animasi sedikit delay
  }

  // centang hijau
  loadingDone.style.display='block';
  await new Promise(r=>setTimeout(r,800));
  loadingOverlay.style.display='none';

  // refresh halaman supaya dashboard muncul
  location.reload();
};
</script>
</body>
</html>
